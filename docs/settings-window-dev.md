# 设置窗口开发文档

## 迭代纪要（2025-09-21）
- ✅ 已完成：设置窗口分组导航、外观/阅读/隐私/快捷键/系统/关于六大模块落地。
- ✅ 已完成：窗口透明度统一驱动 CSS 变量 `--bg-color` / `--bg-color-hidden`，0% 立即透明，淡出状态使用派生透明度。
- ✅ 已完成：设置保存经事件总线同步到主窗口，外观/阅读/快捷键配置实时生效，阅读进度不会被覆盖。
- ✅ 已完成：颜色选择、窗口行为、自动保存间隔、快捷键录制（可重复点击结束）与动态注册。
- ⚠️ 规划中：快捷键冲突提示、开机自启动、设置导入导出、伪装模式自定义内容等高级特性。

> 原始规划章节保留在文档下方，后续落地请同步在此纪要更新勾选状态。

## 当前实现摘要
| 模块 | 状态 | 说明 |
| --- | --- | --- |
| 外观 | ✅ | 透明度、颜色、置顶/任务栏即时生效；CSS 变量与淡出状态已区分。 |
| 阅读 | ✅ | 分页偏移持久化，自动保存间隔驱动定时器。 |
| 隐私 | ✅ | 老板键配置保留，淡出/伪装部分基础项完成，进阶伪装待实现。 |
| 快捷键 | ✅ | 录制、动态注册、事件派发全链路畅通，冲突检测未上线。 |
| 系统 | ⚠️ | 开机自启动、设置导入导出仍在计划中。 |
| 关于 | ✅ | 版本/外链展示。 |

## 后续规划提醒
1. 在实现快捷键冲突检测、伪装模式自定义等能力时，完善对应交互稿与降级策略。
2. 如需新增子模块，请同步更新根目录记忆（`CLAUDE.md` / `AGENTS.md`）与本文件的状态表。
3. 若规划发生结构性调整，可将下方“原始规划”拆分为独立的规范或设计文档。

---
## 项目背景

摸鱼阅读器（moyu-reader）是一个专为隐蔽阅读设计的桌面浮窗应用，具有透明、无边框、置顶和伪装模式等特性。当前设置窗口仅为演示版本，只显示老板键信息。本文档旨在设计并规划一个功能完善的设置窗口。

## 设计原则

1. **隐蔽优先**：所有设置项都应服务于"难被发现"的核心目标
2. **简洁直观**：UI设计保持暗色半透明风格，与主窗口保持一致
3. **即时生效**：大部分设置修改应即时生效，无需重启应用
4. **安全保存**：设置变更自动保存，防止数据丢失

## 设置项规划

### 1. 外观设置

#### 1.1 窗口样式
- **透明度调节**：滑块控制 (10% - 100%)
  - 背景透明度
  - 文字透明度（独立控制）
- **窗口行为**
  - 始终置顶：开关
  - 显示在任务栏：开关
  - 窗口边框：无边框/细边框/标准边框
  - 窗口阴影：开关
- **默认尺寸**
  - 宽度：输入框（像素）
  - 高度：输入框（像素）
  - 记住上次窗口位置：开关

#### 1.2 主题配色
- **预设主题**：下拉选择
  - 深色终端（默认）
  - VSCode 暗色
  - 纸质阅读
  - 护眼模式
  - 自定义
- **自定义颜色**
  - 背景色：颜色选择器
  - 文字颜色：颜色选择器
  - 高亮色：颜色选择器
  - 工具栏背景：颜色选择器

#### 1.3 字体设置
- **字体选择**：下拉菜单
  - 系统字体列表
  - 自定义字体路径
- **字号**：滑块 (12px - 36px)
- **行高**：滑块 (1.0 - 3.0)
- **字间距**：滑块 (-2px - 10px)
- **段落间距**：滑块 (0 - 50px)

### 2. 阅读设置

#### 2.1 分页控制
- **每页最大字符数**：输入框 (100 - 5000)
- **智能断句**：开关
  - 优先在标点符号处分页
  - 避免在对话中间断开
- **分页动画**：无/淡入淡出/滑动

#### 2.2 阅读体验
- **自动保存进度间隔**：下拉选择
  - 即时保存
  - 每5秒
  - 每30秒
  - 每分钟
  - 手动保存
- **文本编码**：下拉选择
  - 自动检测（默认）
  - UTF-8
  - GBK
  - GB2312
- **阅读方向**
  - 垂直滚动
  - 水平翻页

#### 2.3 搜索设置
- **搜索高亮颜色**：颜色选择器
- **大小写敏感**：开关
- **使用正则表达式**：开关
- **搜索历史记录**：开关

### 3. 隐私与伪装

#### 3.1 老板键设置
- **快捷键配置**：快捷键录制器
  - 当前快捷键显示
  - 录制新快捷键按钮
  - 恢复默认按钮
- **触发行为**：下拉选择
  - 显示伪装界面
  - 最小化到托盘
  - 完全隐藏窗口
  - 切换到其他应用

#### 3.2 伪装模式
- **伪装样式**：下拉选择
  - 终端日志（默认）
  - IDE 输出
  - Excel 表格
  - 浏览器页面
  - 自定义HTML
- **伪装内容**：文本框
  - 预设日志模板
  - 自定义文本内容
  - 动态生成选项
- **伪装标题**：输入框

#### 3.3 自动隐藏
- **鼠标离开后自动淡出**：开关
  - 延迟时间：滑块 (1-60秒)
  - 淡出透明度：滑块 (10%-90%)
- **失去焦点后隐藏**：开关
  - 延迟时间：滑块 (0-30秒)
- **定时隐藏**：开关
  - 时间间隔：输入框（分钟）

### 4. 快捷键设置

#### 4.1 导航快捷键
- **上一页**：快捷键录制器
- **下一页**：快捷键录制器
- **跳转到开头**：快捷键录制器
- **跳转到结尾**：快捷键录制器
- **跳转到指定页**：快捷键录制器

#### 4.2 功能快捷键
- **打开文件**：快捷键录制器
- **搜索**：快捷键录制器
- **全屏切换**：快捷键录制器
- **最小模式切换**：快捷键录制器
- **设置窗口**：快捷键录制器

#### 4.3 快捷键方案
- **预设方案**：下拉选择
  - Vim 风格
  - Emacs 风格
  - VS Code 风格
  - 自定义
- **导入/导出配置**：按钮

### 5. 系统设置

#### 5.1 启动选项
- **开机自启动**：开关
- **启动时恢复上次阅读**：开关
- **启动时最小化到托盘**：开关
- **检查更新**：开关

#### 5.2 托盘设置
- **显示托盘图标**：开关
- **单击托盘行为**：下拉选择
  - 显示/隐藏窗口
  - 显示菜单
  - 无操作
- **托盘提示文字**：输入框

#### 5.3 高级设置
- **开发者模式**：开关
  - 显示开发者工具菜单
  - 启用调试日志
- **硬件加速**：开关
- **缓存清理**：按钮
- **重置所有设置**：按钮

### 6. 关于

- 应用版本信息
- 开源协议
- 第三方库致谢
- 检查更新按钮
- 反馈链接

## 技术实现方案

### 前端架构

#### UI 布局
```
设置窗口
├── 侧边栏（导航）
│   ├── 外观设置
│   ├── 阅读设置
│   ├── 隐私与伪装
│   ├── 快捷键设置
│   ├── 系统设置
│   └── 关于
└── 主内容区
    └── 对应设置面板
```

#### 文件结构
```
dist/
├── settings.html       # 设置窗口主页面
├── settings.js        # 设置窗口逻辑
├── settings.css       # 设置窗口样式
└── components/        # 可复用组件
    ├── slider.js      # 滑块组件
    ├── colorpicker.js # 颜色选择器
    └── keybinding.js  # 快捷键录制器
```

### 后端架构

#### 配置结构扩展
```rust
// src-tauri/src/settings.rs

#[derive(Clone, Serialize, Deserialize)]
#[serde(default)]
pub struct AppConfig {
    // 现有配置
    pub last_file: Option<PathBuf>,
    pub last_page: usize,
    pub last_offset: usize,
    pub boss_key: String,
    pub max_chars_per_page: usize,

    // 外观设置
    pub appearance: AppearanceConfig,
    // 阅读设置
    pub reading: ReadingConfig,
    // 隐私设置
    pub privacy: PrivacyConfig,
    // 快捷键设置
    pub keybindings: KeybindingsConfig,
    // 系统设置
    pub system: SystemConfig,
}

#[derive(Clone, Serialize, Deserialize)]
pub struct AppearanceConfig {
    pub opacity: f32,
    pub text_opacity: f32,
    pub always_on_top: bool,
    pub show_in_taskbar: bool,
    pub theme: String,
    pub font_family: String,
    pub font_size: u32,
    pub line_height: f32,
    // ...
}
```

#### 新增命令接口
```rust
// src-tauri/src/commands.rs

#[tauri::command]
pub fn get_all_settings(state: State<'_, AppState>) -> Result<AppConfig, String> {
    // 返回完整配置
}

#[tauri::command]
pub fn update_settings(
    settings: AppConfig,
    state: State<'_, AppState>
) -> Result<(), String> {
    // 更新配置并保存
}

#[tauri::command]
pub fn reset_settings(state: State<'_, AppState>) -> Result<(), String> {
    // 重置为默认配置
}

#[tauri::command]
pub fn apply_theme(theme: String, window: Window) -> Result<(), String> {
    // 应用主题到窗口
}
```

### 数据流设计

1. **设置加载流程**
   - 设置窗口打开 → 调用 `get_all_settings` → 渲染UI
   - 监听主窗口设置变更事件 → 同步更新UI

2. **设置保存流程**
   - 用户修改设置 → 防抖处理(300ms) → 调用 `update_settings`
   - 后端保存配置 → 发送事件到主窗口 → 主窗口应用新设置

3. **实时预览**
   - 外观类设置：通过事件系统实时通知主窗口
   - 快捷键设置：立即注册/注销全局快捷键
   - 隐私设置：立即更新相关状态

## 开发计划

### 第一阶段：基础框架（2天）
1. 创建设置窗口UI框架
2. 实现侧边栏导航
3. 扩展后端配置结构
4. 实现基本的设置加载和保存

### 第二阶段：核心设置（3天）
1. 实现外观设置面板
   - 透明度调节
   - 字体设置
   - 主题切换
2. 实现阅读设置面板
   - 分页控制
   - 自动保存
3. 实现设置的实时预览

### 第三阶段：高级功能（3天）
1. 实现隐私与伪装设置
   - 老板键配置
   - 伪装模式设置
   - 自动隐藏
2. 实现快捷键设置
   - 快捷键录制器组件
   - 快捷键冲突检测
3. 实现系统设置

### 第四阶段：优化完善（2天）
1. 添加设置搜索功能
2. 实现设置导入/导出
3. 添加设置变更历史
4. 性能优化和错误处理
5. 编写用户使用文档

## UI/UX 设计规范

### 视觉风格
- 延续主窗口的暗色半透明风格
- 背景色：#1b1f24
- 文字色：#d7dce2
- 边框色：rgba(255, 255, 255, 0.08)
- 悬停效果：rgba(255, 255, 255, 0.08)

### 交互规范
- 所有可交互元素需要明确的视觉反馈
- 危险操作（如重置设置）需要二次确认
- 输入验证实时进行，错误提示清晰
- 支持键盘导航（Tab键切换）

### 响应式设计
- 最小窗口尺寸：600x500
- 推荐窗口尺寸：800x600
- 支持窗口缩放，内容自适应

## 测试要点

1. **功能测试**
   - 所有设置项的保存和加载
   - 设置实时生效验证
   - 快捷键冲突检测
   - 主题切换效果

2. **兼容性测试**
   - Windows/macOS/Linux 平台测试
   - 不同分辨率显示测试
   - 权限缺失时的降级处理

3. **性能测试**
   - 设置窗口启动速度
   - 大量设置项修改的响应速度
   - 内存占用监控

4. **边界测试**
   - 极限值输入测试
   - 非法输入处理
   - 配置文件损坏恢复

## 注意事项

1. **Context7 文档查询**：任何涉及 Tauri API、系统调用的实现前，必须先通过 Context7 查询最新文档
2. **向后兼容**：新配置项需提供默认值，确保旧版本配置文件可以正常升级
3. **权限控制**：新功能需要在 capabilities/default.json 中声明相应权限
4. **错误处理**：所有设置操作都需要妥善的错误处理和用户友好的提示
5. **性能优化**：避免频繁的文件I/O，使用防抖和节流优化用户输入

## 相关文档

- [Tauri v2 配置文档](https://v2.tauri.app/reference/config/)
- [Tauri 窗口 API](https://v2.tauri.app/reference/javascript/api/namespacewindow/)
- [项目架构文档](./architecture.md)
- [CLAUDE.md](../CLAUDE.md) - 项目开发约束与经验


