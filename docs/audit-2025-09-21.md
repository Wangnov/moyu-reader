# 2025-09-21 代码巡检记录

## 背景
- 目标：从用户体验、隐蔽性、安全性等角度复盘当前 `moyu-reader` 主干实现，识别阻碍体验或潜在风险的缺陷。
- 范围：`dist/` 前端静态资源与 `src-tauri/src/` 后端模块，以及项目配置文档。

## 关键发现
1. **全局快捷键监听抛出异常（严重）**  
   - 位置：`dist/main.js`
   - 现象：监听器中调用了不存在的 `prevPage()`、`nextPage()`，触发即抛 `ReferenceError`，上一页/下一页热键无效。
2. **自动保存逻辑缺失与选项失效（严重）**  
   - `scheduleProgressSave()` 不区分“手动”选项，且定时器调用未定义的 `commitProgress()`，导致报错并无法落盘。
3. **老板键行为与设置脱节（严重）**  
   - `boss_action` 仅伪装模式有效，最小化/隐藏未实现，违背隐蔽诉求。
4. **设置未落地生效（中高）**  
   - `max_chars_per_page`、`smart_break`、`auto_fade`、`fade_delay` 等配置未驱动实际逻辑。
5. **“恢复阅读”开关忽略（中高）**  
   - 后端启动总是恢复上次文件，即使关闭 `restore_reading`。
6. **安全基线不足（中）**  
   - CSP 为 `null` 且 DevTools 默认启用，存在注入风险。
7. **长文本重复拷贝（中）**  
   - `load_document_internal` 写入后又复制快照，放大内存与 IO。
8. **UI 恢复入口缺失（中）**  
   - `ui-restore` 样式存在但无按钮，Minimal 模式需托盘恢复。

## 处理进度
- 2025-09-21 梳理修复顺序，准备编码实施。
- 2025-09-21 修复主窗口快捷键、自动保存策略、老板键动作、配置生效逻辑，并补充 UI 恢复入口/安全配置。
- 2025-09-21 扩充窗口权限并修复透明度 0% 失效问题，老板键最小化/隐藏模式可用。
- 2025-09-21 生成多平台图标并配置 bundle.icon，打包流程通过。

### 测试记录
- 2025-09-21 `npm run build`：生成 MSI/NSIS 安装包成功，产物位于 `src-tauri/target/release/bundle/`。
